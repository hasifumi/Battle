// Generated by CoffeeScript 1.3.3
(function() {
  var BattleEngine, BattleScene, BattleTest, Charactor, MessageView, Utilfunc, roundFrame,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  enchant();

  BattleTest = (function(_super) {

    __extends(BattleTest, _super);

    BattleTest.prototype.config = {
      WIDTH: 320,
      HEIGHT: 320,
      FPS: 30
    };

    function BattleTest() {
      BattleTest.__super__.constructor.call(this, this.config.WIDTH, this.config.HEIGHT);
      this.fps = this.config.FPS;
      this.onload = function() {
        this.player = new Charactor({
          name: "player1",
          maxHp: 100
        });
        console.log("" + this.player.name + " create");
        this.enemy = new Charactor({
          name: "enemy1",
          maxHp: 50
        });
        console.log("" + this.enemy.name + " create");
        this.scenes = {};
        this.scenes.battle = new BattleScene();
        this.replaceScene(this.scenes.battle);
      };
      this.start();
    }

    return BattleTest;

  })(Game);

  window.onload = function() {
    return new BattleTest;
  };

  Charactor = (function() {

    function Charactor(param) {
      this.name = param.name;
      this.maxHp = param.maxHp;
      this.hp = this.maxHp;
      this.isDead = false;
    }

    Charactor.prototype.damage = function(value) {
      var hp;
      hp = this.hp;
      hp -= value;
      if (hp < 0) {
        this.hp = 0;
        return this.isDead = true;
      } else {
        return this.hp = hp;
      }
    };

    Charactor.prototype.recovery = function(value) {
      return this.hp += value;
    };

    return Charactor;

  })();

  BattleScene = (function(_super) {

    __extends(BattleScene, _super);

    function BattleScene() {
      var lblAttack,
        _this = this;
      BattleScene.__super__.constructor.call(this);
      this.backgroundColor = "black";
      this.game = enchant.Game.instance;
      this.bEngine = new BattleEngine();
      this.bEngine.addMember(this.game.player);
      this.bEngine.addMember(this.game.enemy);
      lblAttack = new Label("Attack");
      lblAttack.color = "orange";
      lblAttack.x = 50;
      lblAttack.y = 50;
      lblAttack.addEventListener('touchend', function() {
        console.log("lblAttack touched");
        _this.bEngine.addCommand("attack");
        return _this.bEngine.nextTurn();
      });
      this.addEventListener('enterframe', function() {
        return this.bEngine.update();
      });
      this.addChild(lblAttack);
    }

    return BattleScene;

  })(Scene);

  BattleEngine = (function() {

    function BattleEngine() {
      this.doCommand = __bind(this.doCommand, this);

      this.commandAttack = __bind(this.commandAttack, this);

      this.clearCommand = __bind(this.clearCommand, this);

      this.addCommand = __bind(this.addCommand, this);

      this.nextTarget = __bind(this.nextTarget, this);

      this.nextTurn = __bind(this.nextTurn, this);

      this.changeState = __bind(this.changeState, this);

      this.addMember = __bind(this.addMember, this);

      this.update = __bind(this.update, this);
      this.state = "waitCommand";
      this.members = [];
      this.commands = [];
      this.turn = 0;
      this.target = 1;
      this.game = enchant.Game.instance;
    }

    BattleEngine.prototype.update = function() {
      switch (this.state) {
        case "waitCommand":
          break;
        case "doCommand":
          return this.doCommand();
        default:
          return console.log("else");
      }
    };

    BattleEngine.prototype.addMember = function(member) {
      return this.members.push(member);
    };

    BattleEngine.prototype.changeState = function(state) {
      return this.state = state;
    };

    BattleEngine.prototype.nextTurn = function() {
      if (this.turn >= this.members.length - 1) {
        this.turn = 0;
        this.nextTarget();
        return this.changeState("doCommand");
      } else {
        this.turn++;
        return this.nextTarget();
      }
    };

    BattleEngine.prototype.nextTarget = function() {
      if (this.target >= this.members.length - 1) {
        return this.target = 0;
      } else {
        return this.target++;
      }
    };

    BattleEngine.prototype.addCommand = function(command) {
      this.commands.push({
        command: command,
        turn: this.turn,
        target: this.target
      });
      return console.log("addCommand command:" + command + ", turn:" + this.turn + ", target:" + this.target);
    };

    BattleEngine.prototype.clearCommand = function() {
      return this.commands = [];
    };

    BattleEngine.prototype.commandAttack = function(turn, target) {
      var damage, target_name, turn_name;
      damage = 10;
      turn_name = this.members[turn].name;
      target_name = this.members[target].name;
      this.members[target].damage(damage);
      console.log("" + turn_name + " attack " + target_name + "!");
      console.log("" + target_name + " damaged " + damage + "!");
      return console.log("" + target_name + "'s hp:" + this.members[target].hp + ", maxHp:" + this.members[target].maxHp + "!");
    };

    BattleEngine.prototype.doCommand = function() {
      var i, _i, _len, _ref;
      _ref = this.commands;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        i = _ref[_i];
        switch (i.command) {
          case "attack":
            this.commandAttack(i.turn, i.target);
            break;
          default:
            return;
        }
      }
      this.clearCommand();
      this.changeState("waitCommand");
      if (this.game.player.hp <= 0) {
        console.log("Game Over!");
        this.game.stop();
      }
      if (this.game.enemy.hp <= 0) {
        console.log("Game Clear!!");
        return this.game.stop();
      }
    };

    return BattleEngine;

  })();

  roundFrame = (function(_super) {

    __extends(roundFrame, _super);

    function roundFrame(w, h, lw) {
      var ctx, sp1, sp2, sur1, sur2;
      roundFrame.__super__.constructor.call(this);
      sur1 = new Surface(w, h);
      ctx = sur1.context;
      ctx.fillStyle = "white";
      ctx.rect(0, 0, w, h);
      ctx.fill();
      sp1 = new Sprite(w, h);
      sp1.image = sur1;
      sp1.opacity = 0.4;
      this.addChild(sp1);
      sur2 = new Surface(w - lw * 2, h - lw * 2);
      ctx = sur2.context;
      ctx.fillStyle = "#ff8c00";
      ctx.rect(0, 0, w - lw * 2, h - lw * 2);
      ctx.fill();
      sp2 = new Sprite(w - lw * 2, h - lw * 2);
      sp2.image = sur2;
      sp2.opacity = 0.4;
      sp2.x = lw;
      sp2.y = lw;
      this.addChild(sp2);
    }

    return roundFrame;

  })(Group);

  MessageView = (function(_super) {

    __extends(MessageView, _super);

    function MessageView(w, h, lw) {
      var lbl;
      if (w != null) {
        this.w = w;
      } else {
        this.w = 310;
      }
      if (h != null) {
        this.h = h;
      } else {
        this.h = 30;
      }
      if (lw != null) {
        this.lw = lw;
      } else {
        this.lw = 2;
      }
      MessageView.__super__.constructor.call(this, this.w, this.h, this.lw);
      lbl = new Label("");
      lbl.font = "12px sans-serif";
      lbl.color = "white";
      lbl.x = 5;
      lbl.width = 310 - 5 * 2;
      lbl.height = 24;
      this.addChild(lbl);
      this.setText = function(text) {
        return lbl.text = text;
      };
    }

    MessageView.prototype.setText = function(text) {
      return this.setText(text);
    };

    return MessageView;

  })(roundFrame);

  Utilfunc = (function() {

    function Utilfunc() {}

    Utilfunc.prototype.flg = false;

    Utilfunc.prototype.getTextLength = function(text) {
      var i, len, _i, _len;
      len = 0;
      for (_i = 0, _len = text.length; _i < _len; _i++) {
        i = text[_i];
        if (this.flg) {
          console.log("i:" + i);
        }
        if (this.isZenkaku(text.charAt(_i))) {
          len += 2;
        } else {
          len++;
        }
      }
      if (this.flg) {
        console.log("original: " + text.length);
        console.log("escape  : " + len);
      }
      return len;
    };

    Utilfunc.prototype.isZenkaku = function(char) {
      var _char;
      _char = escape(char);
      if (this.flg) {
        console.log("char(all:" + _char);
        console.log("charAt(0-1):" + _char.charAt(0) + _char.charAt(1));
      }
      if (_char.charAt(0) !== "%") {
        return false;
      }
      switch (_char.charAt(1)) {
        case "8":
        case "9":
        case "E":
        case "F":
        case "u":
          return true;
        default:
          return false;
      }
    };

    return Utilfunc;

  })();

}).call(this);
